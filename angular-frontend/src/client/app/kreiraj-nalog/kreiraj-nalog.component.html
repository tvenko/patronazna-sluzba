<sd-navbar></sd-navbar>
<p>KREIRANJE NALOGA</p>

<form [formGroup]="myForm" novalidate (ngSubmit)="myForm.valid && pregled()">
  <!-- Izvajalec -->
  <div class="panel panel-success" >
    <div class="panel-heading">
      <h3 class="panel-title">Izvajalec</h3>
    </div>
    <div class="panel-body">
      // TODO preko delavca v seji <br>
      Stevilka izvajalca:
      Naziv izvajalca:
    </div>
  </div>
  <!-- Zdravnik -->
  <div class="panel panel-success" >
    <div class="panel-heading">
      <h3 class="panel-title">Zdravnik</h3>
    </div>
    <div class="panel-body">
      // TODO preko seje <br>
      Stevilka zdravnika:
      Naziv zdravnika:
    </div>
  </div>

  <!-- Dropdown za izbiro vrste obiska -->
  <div class="panel panel-success">
    <div class="panel-heading">
      <h3 class="panel-title">Vrsta obiska</h3>
    </div>
    <div class="panel-body">
      <div class="form-group" [ngClass]="{'has-error':!myForm.controls.vrstaObiska.valid}">
        <select class="form-control" *ngIf="vrsteObiskov" formControlName="vrstaObiska">
          <option *ngFor="let obisk of vrsteObiskov.results" [ngValue]="obisk">
            {{ obisk.opis }}
          </option>
        </select>
        <small *ngIf="!myForm.controls.vrstaObiska.valid" class="text-danger">
          Vrsta obiska je obvezen podatek.
        </small>
      </div>
    </div>
  </div>
  <div *ngIf="!vrsteObiskov?.results">
    <div *ngIf="problemPridobivanja" class="alert alert-warning" role="alert">
      <strong>Opa!</strong> Prišlo je do napake pri povezavi s strežnikom.
    </div>
  </div>

  <!-- Potrebno je napisati material pri aplikaciji injekcij -->
  <div class="panel panel-success" *ngIf="prikaziMaterial()">
    <div class="panel-heading">
      <h3 class="panel-title">Material potreben za obisk</h3>
    </div>
    <div class="panel-body">
      <div class="container">
        <div *ngIf="aliRabiZdravilo()">

          <!-- Pri aplikaciji injekcij moras izbrati zdravilo -->
          <div formArrayName="zdravila">
            <div *ngFor="let zdravilo of myForm.controls.zdravila.controls; let i=index">
              <div>
                <span> Zdravilo {{i + 1}}</span>
                <i class="material-icons clickable" *ngIf="myForm.controls.zdravila.length > 1" (click)="odstraniZdravilo(i)">highlight_off</i>
              </div>
              <div [formGroupName]="i"  class="form-group">
                <!-- Vnosno polje za izbiro zdravila -->
                <div>
                  <label>Naziv</label>
                  <select class="form-control" formControlName="naziv">
                    <option *ngFor="let lek of zdravila.results" [ngValue]="lek">
                      {{ lek.naziv }}
                    </option>
                  </select>
                  <!--<small [hidden]="!myForm.controls.zdravila.controls[i].controls.naziv.valid" class="text-danger">

                </small>-->
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-info btn-xs" (click)="dodajZdravilo()">Dodaj zdravilo</button>

      </div>

      <!-- Pri odvzemu krvi moras izbrati materiali in kolicino -->
      <div *ngIf="aliRabiMaterial()">
        <div formArrayName="materiali">
          <div *ngFor="let material of myForm.controls.materiali.controls; let i=index">
            <div>
              <span> Material {{i + 1}}</span>
              <i class="material-icons clickable" *ngIf="myForm.controls.materiali.length > 1" (click)="odstraniMaterial(i)">highlight_off</i>
            </div>
            <div [formGroupName]="i" class="form-group">
              <!-- Vnosno polje za izbiro zdravila -->
              <div>
                <label>Opis</label>
                <select class="form-control" formControlName="opis">
                  <option *ngFor="let material of epruvete.results">
                    {{ material.opis }}
                  </option>
                </select>
                <!--<small [hidden]="!myForm.controls.materiali.controls[i].controls.opis.valid">Opis je obvezno polje</small>-->
              </div>
              <!-- Vnosno polje za kolicino -->
              <div>
                <label>Kolicina</label>
                <input class="form-control" type="number" formControlName="kolicina" min="1">
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-info btn-xs" (click)="dodajMaterial()">Dodaj material</button>
      </div>

    </div>
  </div>
</div>

<!-- Zavarovana oseba (lahko vec pri obisku otrocnice)-->
<div class="panel panel-success" >
  <div class="panel-heading">
    <h3 class="panel-title">Zavarovana oseba</h3>
  </div>
  <div class="panel-body">
    <div class="form-group" [ngClass]="{'has-error':!myForm.controls.stevilkaPacienta.valid}">
      <label>Številka zavarovane osebe</label>
      <input class="form-control" type="text" formControlName="stevilkaPacienta" required/>
      <button type="button" class="btn btn-primary btn-xs" (click)="myForm.controls.stevilkaPacienta.valid && pridobiPodatke()">Pridobi podatke</button>
      <small *ngIf="!myForm.controls.stevilkaPacienta.valid" class="text-danger">
        Številka pacienta je obvezna in mora vsebovati 9 števk.
      </small>
      <!-- TODO Napaka za izpad baze? -->
      <div *ngIf="problemPridobivanja" class="alert alert-warning" role="alert">
        <strong>Joj!</strong> Prišlo je do napake pri pridobivanju podatkov.
      </div>
      <!-- TODO Izpisi ce je vec pacientov -->
      <div *ngIf="!neveljavnaStevilka && neveljavnaStevilka != undefined && !problemPridobivanja && pacient">
        Datum rojstva: {{ pacient.datumRojstva }} <br>
        Priimek: {{ pacient.priimek }} <br>
        Ime: {{ pacient.ime }} <br>
        Ulica, hišna številka: {{ pacient.ulica }}, {{pacient.hisnaStevilka}} <br>
        Poštna številka: {{ pacient.posta }} <br>
        Kraj: {{ pacient.kraj }} <br>
        Telefonska: {{ pacient.telefon }} <br>
        E-pošta: {{ pacient.eposta }} <br>
        ID kontaktne osebe: {{ pacient.kontaktnaOseba }} <br>
        <!-- Prikazi le ce se je backend odzval? (bi bilo bolje hardkodirano?) -->
        <div *ngIf="myForm.controls.vrstaObiska.value?.vezani_pacienti">
          Vezani pacienti:
          <ul>
            <li *ngFor="let otrok of pacient.vezani_pacienti">
              {{ otrok.ime }} {{ otrok.priimek }}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Izbira casovnega obdobja za obisk -->
<div class="panel panel-success">
  <div class="panel-heading">
    <h3 class="panel-title">Datum obiska</h3>
  </div>
  <div class="panel-body">
    <div class="form-group" [ngClass]="{'has-error':!myForm.controls.prviDatum.valid}">
      <label>Datum prvega obiska</label>
      <p-calendar formControlName="prviDatum" dateFormat="dd.mm.yy" [locale]="si" [minDate]="minDate" [disabledDays]="[0,6]" [readonlyInput]="true" required></p-calendar>
      <small *ngIf="!myForm.controls.prviDatum.valid" class="text-danger">
        Datum ni veljaven
      </small>
    </div>
    <div class="form-group" [ngClass]="{'has-error':!myForm.controls.obvezen.valid}">
      <p-radioButton name="obveznostDatuma" label="Datum je spremenljiv" value="false" formControlName="obvezen"></p-radioButton>
      <p-radioButton class="left-margin" name="obveznostDatuma" label="Datum je obvezen" value="true" formControlName="obvezen" required></p-radioButton>
    </div>
    <div class="form-group" [ngClass]="{'has-error':!myForm.controls.steviloObiskov.valid}">
      <label>Število obiskov</label>
      <input type="number" formControlName="steviloObiskov" class="form-control" min="1" max="10" required>
      <small *ngIf="!myForm.controls.steviloObiskov.valid" class="text-danger">
        Vnesite število obiskov (1 do 10)
      </small>
    </div>
    <div formGroupName="obdobjeObiskov">
      <p-radioButton name="intervalAliZadnjiDan" label="Izberi interval obiskov" value="vmesniDnevi" formControlName="type"></p-radioButton>
      <p-radioButton class="left-margin" name="intervalAliZadnjiDan" label="Izberi zadnji datum" value="zadnjiDan" formControlName="type"></p-radioButton>
    </div>
    <!-- Group za izbiro vmesnih dni med obiski -->
    <div formGroupName="obdobjeObiskov" *ngIf="myForm.controls.obdobjeObiskov.controls.type.value == 'vmesniDnevi'" [ngClass]="{'has-error':!myForm.controls.obdobjeObiskov.controls.interval.valid}">
      <label>Interval med obiski</label>
      <input type="number" min="1" class="form-control" formControlName="interval">
      <small *ngIf="!myForm.controls.obdobjeObiskov.controls.interval.valid" class="text-danger">
        Vnesite število dni, ki naj pretečejo med obiski
      </small>
    </div>
    <!-- Group za izbiro koncnega datuma -->
    <div formGroupName="obdobjeObiskov" *ngIf="izracunajMinimalenDatum()" [ngClass]="{'has-error':!myForm.controls.obdobjeObiskov.controls.koncniDatum.valid}">
      <label>Datum zadnjega obiska</label>
      <p-calendar formControlName="koncniDatum" dateFormat="dd.mm.yy" [locale]="si" [minDate]="minDateKoncen" [disabledDays]="[0,6]" [readonlyInput]="true"></p-calendar>
      <small *ngIf="!myForm.controls.obdobjeObiskov.controls.koncniDatum.valid" class="text-danger">
        Izberite datum zadnjega obiska
      </small>
    </div>
  </div>

</div>
<button pButton type="submit" label="Naprej" class="md-margin" [disabled]="!myForm.valid"></button>
<small *ngIf="!myForm.valid" class="text-danger">
  Obrazec še ni veljaven
</small>
</form>
